
{% extends "base.html" %}
{% block content %}

<div class="dp-header">
  <div>
    <div class="dp-brand text-uppercase">Plan for {{ plan.date }}</div>
    <nav class="dp-nav d-flex align-items-center gap-2 mt-1" aria-label="Day navigation">
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('index', date=prev_day.strftime('%Y-%m-%d')) }}">&larr; {{ prev_day.strftime('%a %d %b') }}</a>
      <span class="dp-muted">Planning</span>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('index', date=next_day.strftime('%Y-%m-%d')) }}">{{ next_day.strftime('%a %d %b') }} &rarr;</a>
    </nav>
  </div>
  <form class="dp-toolbar" hx-post="/settings" hx-target="#blocks" hx-swap="outerHTML">
    <input type="hidden" name="date" value="{{ plan.date }}"/>
    <div class="d-flex align-items-center gap-2 flex-wrap">
      <div class="form-text m-0">Start</div>
      <input type="time" class="form-control form-control-sm" name="start" value="{{ plan.start }}" style="width: 8.5rem;"/>
      <div class="form-text m-0">End</div>
      <input type="time" class="form-control form-control-sm" name="end" value="{{ plan.end }}" style="width: 8.5rem;"/>
      <button type="submit" class="btn btn-primary btn-sm">Apply</button>
    </div>
  </form>
</div>

<div class="dp-cols">
  {% include "partials/blocks.html" %}
  <aside>
    <h6 class="text-uppercase text-muted mb-2">Today's Toâ€‘Dos</h6>
    <form class="dp-todos mb-2" hx-post="/todo" hx-target="#todos" hx-swap="outerHTML" hx-on::after-swap="this.reset()">
      <input type="hidden" name="date" value="{{ plan.date }}"/>
      <div class="input-group input-group-sm mb-2">
        <input name="text" class="form-control" placeholder="Add a todo (press Enter)"/>
        <input name="minutes" type="number" min="1" step="1" class="form-control" style="max-width: 7rem;" placeholder="mins"/>
        <button type="submit" class="btn btn-primary">Add</button>
      </div>
    </form>
    <div id="todos" class="dp-todos">
      {% include "partials/todos.html" %}
    </div>
    <p class="dp-muted mt-2">Tips: click a todo to prefill a block; Press Enter to set, Ctrl+Enter to clear; use Arrow Up/Down to move.</p>
  </aside>
</div>

<script>
  // lightweight UX: click a todo to copy text into the last focused slot input
  let lastInput = null;
  document.addEventListener('focusin', (e) => {
    if (e.target.matches('.dp-slot input[name="text"]')) {
      lastInput = e.target;
    }
  });
  document.addEventListener('click', (e) => {
    if (e.target.matches('.todo-pick')) {
      const txt = e.target.getAttribute('data-text') || e.target.textContent;
      if (lastInput) { lastInput.value = txt.trim(); lastInput.focus(); }
    }
  });

  // Keyboard navigation and quick submit
  let submitDirection = 'next'; // or 'prev'
  document.addEventListener('keydown', (e) => {
    const slot = e.target.closest('.dp-slot');
    if (!slot) return;

    // Enter on slot container focuses its input
    if (e.key === 'Enter' && e.target === slot) {
      const input = slot.querySelector('input[name="text"]');
      if (input) { input.focus(); e.preventDefault(); }
    }

    // Enter inside input submits the form
    if (e.key === 'Enter' && e.target.matches('.dp-slot input[name="text"]')) {
      const form = e.target.closest('form');
      if (form) {
        submitDirection = e.shiftKey ? 'prev' : 'next';
        e.preventDefault();
        if (e.ctrlKey) {
          // Ctrl+Enter clears
          const clearBtn = form.querySelector('[hx-post="/block/clear"]');
          if (clearBtn) clearBtn.click();
        } else {
          if (form.requestSubmit) form.requestSubmit(); else form.submit();
        }
      }
    }

    // Arrow navigation between slots
    if ((e.key === 'ArrowDown' || e.key === 'ArrowUp') && slot) {
      const slots = Array.from(document.querySelectorAll('#blocks .dp-slot'));
      const idx = slots.indexOf(slot);
      let targetIdx = idx + (e.key === 'ArrowDown' ? 1 : -1);
      if (targetIdx < 0) targetIdx = 0; if (targetIdx >= slots.length) targetIdx = slots.length - 1;
      const target = slots[targetIdx];
      if (target) { target.focus(); e.preventDefault(); }
    }
  });

  // After a cell swaps (set or clear), move focus to next/prev slot's input for fast data entry
  document.body.addEventListener('htmx:afterSwap', (evt) => {
    const el = evt.target; // swap target
    if (!(el && el.id && el.id.startsWith('cell-'))) return;
    // Focus input inside swapped cell first (it may rerender)
    const input = el.querySelector('input[name="text"]');
    if (input) input.focus();
    const slots = Array.from(document.querySelectorAll('#blocks .dp-slot'));
    const idx = slots.indexOf(el);
    if (idx >= 0) {
      const nextIdx = submitDirection === 'prev' ? Math.max(0, idx - 1) : Math.min(slots.length - 1, idx + 1);
      const target = slots[nextIdx];
      const tInput = target && target.querySelector('input[name="text"]');
      if (tInput) tInput.focus();
    }
  });
</script>

{% endblock %}
